<?php
/**
 * Template for taxonomy vung_mien (results page with filters)
 */

get_header();
$term = get_queried_object();

// Lấy filter từ URL
$khoi_hanh = isset($_GET['khoihanh']) ? sanitize_text_field($_GET['khoihanh']) : '';
$thoi_gian = isset($_GET['thoi_gian']) ? sanitize_text_field($_GET['thoi_gian']) : '';
$gia_khoang = isset($_GET['gia_khoang']) ? sanitize_text_field($_GET['gia_khoang']) : '';
$diemden = isset($_GET['diemden']) ? sanitize_text_field($_GET['diemden']) : '';

$paged = get_query_var('paged') ? get_query_var('paged') : 1;

$args = [
    'post_type' => 'tour',
    'posts_per_page' => 10,
    'paged' => $paged,
    'tax_query' => [[
        'taxonomy' => 'vung_mien',
        'field'    => 'slug',
        'terms'    => $term->slug,
    ]],
    'meta_query' => [],
];

if ($khoi_hanh) {
    $args['meta_query'][] = [
        'key' => 'khoihanh',
        'value' => $khoi_hanh,
        'compare' => '='
    ];
}
if ($thoi_gian) {
    $args['meta_query'][] = [
        'key' => 'thoi_gian',
        'value' => $thoi_gian,
        'compare' => '='
    ];
}
if ($gia_khoang) {
    $range = explode('-', $gia_khoang);
    if (count($range) === 2) {
        $args['meta_query'][] = [
            'key' => 'gia_tour',
            'value' => [$range[0], $range[1]],
            'type' => 'NUMERIC',
            'compare' => 'BETWEEN'
        ];
    }
}
if ($diemden) {
    $args['meta_query'][] = [
        'key' => 'diem_den',
        'value' => $diemden,
        'compare' => 'LIKE'
    ];
}

$query = new WP_Query($args);

// Lấy giá trị lọc thực tế từ bài viết
$post_ids = get_posts([
    'post_type' => 'tour',
    'numberposts' => -1,
    'fields' => 'ids',
    'tax_query' => [[
        'taxonomy' => 'vung_mien',
        'field' => 'slug',
        'terms' => $term->slug
    ]],
]);

$khoihanh_values = [];
$thoi_gian_values = [];
foreach ($post_ids as $id) {
    $kh = get_post_meta($id, 'khoihanh', true);
    $tg = get_post_meta($id, 'thoi_gian', true);
    if ($kh) $khoihanh_values[] = $kh;
    if ($tg) $thoi_gian_values[] = $tg;
}
$khoihanh_values = array_unique($khoihanh_values);
$thoi_gian_values = array_unique($thoi_gian_values);

$child_terms = get_terms([
    'taxonomy' => 'vung_mien',
    'parent' => $term->term_id,
    'hide_empty' => false,
]);

?>

<div style="max-width: 1140px; margin: auto; display: flex; gap: 24px; margin-top: 32px;">
  <!-- Sidebar Filter -->
  <aside style="width: 250px;">
    <form method="get">
      <h3>Bộ lọc</h3>

      <?php if ($khoihanh_values): ?>
      <label>Khởi hành từ:</label><br>
      <select name="khoihanh" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <?php foreach ($khoihanh_values as $val): ?>
          <option value="<?php echo esc_attr($val); ?>" <?php selected($khoi_hanh, $val); ?>><?php echo esc_html($val); ?></option>
        <?php endforeach; ?>
      </select>
      <?php endif; ?>
<?php if ($thoi_gian_values): ?>
      <label>Thời gian combo:</label><br>
      <select name="thoi_gian" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <?php foreach ($thoi_gian_values as $val): ?>
          <option value="<?php echo esc_attr($val); ?>" <?php selected($thoi_gian, $val); ?>><?php echo esc_html($val); ?></option>
        <?php endforeach; ?>
      </select>
      <?php endif; ?>

      <label>Mức giá trong khoảng:</label><br>
      <select name="gia_khoang" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <option value="1000000-5000000" <?php selected($gia_khoang, '1000000-5000000'); ?>>Từ 1 triệu đến 5 triệu</option>
        <option value="5000000-10000000" <?php selected($gia_khoang, '5000000-10000000'); ?>>Từ 5 triệu đến 10 triệu</option>
        <option value="10000000-20000000" <?php selected($gia_khoang, '10000000-20000000'); ?>>Từ 10 triệu đến 20 triệu</option>
        <option value="20000000-30000000" <?php selected($gia_khoang, '20000000-30000000'); ?>>Từ 20 triệu đến 30 triệu</option>
        <option value="30000000-999999999" <?php selected($gia_khoang, '30000000-999999999'); ?>>Trên 30 triệu</option>
      </select>

      <?php if ($child_terms): ?>
      <label>Điểm đến:</label><br>
      <select name="diemden" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <?php foreach ($child_terms as $child): ?>
          <option value="<?php echo esc_attr($child->slug); ?>" <?php selected($diemden, $child->slug); ?>><?php echo esc_html($child->name); ?></option>
        <?php endforeach; ?>
      </select>
      <?php endif; ?>

      <button type="submit" style="margin-top: 10px; padding: 8px 16px; background: #e1703a; color: white; border: none; border-radius: 6px; cursor: pointer;">Lọc</button>
    </form>
  </aside>

  <!-- Main Content -->
  <main style="flex: 1;">
    <h1>Kết quả tour ở <?php echo esc_html($term->name); ?></h1>

    <?php if ($query->have_posts()): ?>
      <div style="display: flex; flex-direction: column; gap: 24px;">
        <?php while ($query->have_posts()): $query->the_post(); ?>
          <div style="border: 1px solid #eee; padding: 16px; border-radius: 8px; display: flex; gap: 16px;">
            <div style="flex: 0 0 200px;">
              <?php if (has_post_thumbnail()): ?>
                <?php the_post_thumbnail('medium', ['style' => 'border-radius: 8px;']); ?>
              <?php endif; ?>
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0;"><a href="<?php the_permalink(); ?>" style="color: #333; text-decoration: none;"><?php the_title(); ?></a></h3>
              <p><strong>Khởi hành:</strong> <?php the_field('khoihanh'); ?> | <strong>Thời gian:</strong> <?php the_field('thoi_gian'); ?></p>
<p><strong>Giá:</strong> <?php echo get_field('gia_tour') ? number_format(get_field('gia_tour'), 0, ',', '.') . ' đ' : 'Liên hệ'; ?></p>
              <a href="<?php the_permalink(); ?>" style="color: #e1703a; font-weight: bold;">Xem chi tiết &raquo;</a>
            </div>
          </div>
        <?php endwhile; ?>
      </div>

      <div style="margin-top: 24px;">
        <?php
        echo paginate_links([
          'total' => $query->max_num_pages
        ]);
        ?>
      </div>

    <?php else: ?>
      <p>Không tìm thấy tour phù hợp.</p>
    <?php endif; ?>
    <?php wp_reset_postdata(); ?>
  </main>
</div>

<?php get_footer(); ?>
