<?php
/**
 * Template for taxonomy vung_mien (results page with filters)
 */

get_header();
$term = get_queried_object();

// Get filter values from URL
$khoi_hanh_tu = isset($_GET['khoi_hanh_tu']) ? sanitize_text_field($_GET['khoi_hanh_tu']) : '';
$thoi_gian = isset($_GET['thoi_gian']) ? sanitize_text_field($_GET['thoi_gian']) : '';
$loai_combo = isset($_GET['loai_combo']) ? sanitize_text_field($_GET['loai_combo']) : '';
$muc_gia = isset($_GET['muc_gia']) ? sanitize_text_field($_GET['muc_gia']) : '';
$diem_den = isset($_GET['diem_den']) ? sanitize_text_field($_GET['diem_den']) : '';

$paged = get_query_var('paged') ? get_query_var('paged') : 1;

$args = [
    'post_type' => 'tour',
    'posts_per_page' => 10,
    'paged' => $paged,
    'tax_query' => [[
        'taxonomy' => 'vung_mien',
        'field'    => 'slug',
        'terms'    => $term->slug,
    ]],
    'meta_query' => [],
];

if ($khoi_hanh_tu) {
    $args['meta_query'][] = [
        'key' => 'khoi_hanh_tu',
        'value' => $khoi_hanh_tu,
        'compare' => 'LIKE'
    ];
}
if ($thoi_gian) {
    $args['meta_query'][] = [
        'key' => 'thoi_gian',
        'value' => $thoi_gian,
        'compare' => 'LIKE'
    ];
}
if ($loai_combo) {
    $args['meta_query'][] = [
        'key' => 'loai_combo',
        'value' => $loai_combo,
        'compare' => 'LIKE'
    ];
}
if ($diem_den) {
    $args['meta_query'][] = [
        'key' => 'diem_den',
        'value' => $diem_den,
        'compare' => 'LIKE'
    ];
}
if ($muc_gia === '1-5') {
    $args['meta_query'][] = [
        'key' => 'gia_khuyenmai',
        'value' => [1000000, 5000000],
        'type' => 'NUMERIC',
        'compare' => 'BETWEEN'
    ];
} elseif ($muc_gia === '5-10') {
    $args['meta_query'][] = [
        'key' => 'gia_khuyenmai',
        'value' => [5000000, 10000000],
        'type' => 'NUMERIC',
        'compare' => 'BETWEEN'
    ];
} elseif ($muc_gia === '10-15') {
    $args['meta_query'][] = [
        'key' => 'gia_khuyenmai',
        'value' => [10000000, 15000000],
        'type' => 'NUMERIC',
        'compare' => 'BETWEEN'
    ];
}

$query = new WP_Query($args);
?>

<div style="max-width: 1140px; margin: auto; display: flex; gap: 24px; margin-top: 32px;">
  <!-- Sidebar Filter -->
  <aside style="width: 250px;">
    <form method="get">
      <h3>Bộ lọc</h3>

      <label>Khởi hành từ:</label><br>
      <select name="khoi_hanh_tu" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <option value="ha-noi" <?php selected($khoi_hanh_tu, 'ha-noi'); ?>>Hà Nội</option>
        <option value="ho-chi-minh" <?php selected($khoi_hanh_tu, 'ho-chi-minh'); ?>>Hồ Chí Minh</option>
      </select>

      <label>Thời gian combo:</label><br>
      <select name="thoi_gian" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <option value="2n1d">2 ngày 1 đêm</option>
        <option value="3n2d">3 ngày 2 đêm</option>
        <option value="4n3d">4 ngày 3 đêm</option>
        <option value="5n4d">5 ngày 4 đêm</option>
        <option value="6n5d">6 ngày 5 đêm</option>
      </select>

      <label>Loại combo:</label><br>
      <select name="loai_combo" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <option value="maybay-khachsan">Vé máy bay + khách sạn</option>
        <option value="tour-tron-goi">Tour trọn gói</option>
      </select>

      <label>Mức giá trong khoảng:</label><br>
      <select name="muc_gia" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <option value="1-5" <?php selected($muc_gia, '1-5'); ?>>Từ 1 triệu đến 5 triệu</option>
        <option value="5-10" <?php selected($muc_gia, '5-10'); ?>>Từ 5 triệu đến 10 triệu</option>
        <option value="10-15" <?php selected($muc_gia, '10-15'); ?>>Từ 10 triệu đến 15 triệu</option>
      </select>

      <label>Điểm đến:</label><br>
      <select name="diem_den" style="width: 100%; padding: 6px;">
        <option value="">-- Chọn --</option>
        <option value="ham-rong" <?php selected($diem_den, 'ham-rong'); ?>>Hàm Rồng</option>
        <option value="ban-cat-cat" <?php selected($diem_den, 'ban-cat-cat'); ?>>Bản Cát Cát</option>
        <option value="cong-troi-sapa" <?php selected($diem_den, 'cong-troi-sapa'); ?>>Cổng Trời Sapa</option>
        <option value="fansipan" <?php selected($diem_den, 'fansipan'); ?>>Đình Fansipan</option>
      </select>

      <button type="submit" style="margin-top: 10px; padding: 8px 16px; background: #e1703a; color: white; border: none; border-radius: 6px; cursor: pointer;">Lọc</button>
    </form>
  </aside>

  <!-- Main Content -->
  <main style="flex: 1;">
    <h1>Kết quả tour ở <?php echo esc_html($term->name); ?></h1>

    <?php if ($query->have_posts()): ?>
      <div style="display: flex; flex-direction: column; gap: 24px;">
        <?php while ($query->have_posts()): $query->the_post(); ?>
          <div style="border: 1px solid #eee; padding: 16px; border-radius: 8px; display: flex; gap: 16px;">
            <div style="flex: 0 0 200px;">
              <?php if (has_post_thumbnail()): ?>
                <?php the_post_thumbnail('medium', ['style' => 'border-radius: 8px;']); ?>
              <?php endif; ?>
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0;"><a href="<?php the_permalink(); ?>" style="color: #333; text-decoration: none;"><?php the_title(); ?></a></h3>
              <p><strong>Khởi hành:</strong> <?php the_field('khoi_hanh_tu'); ?> | <strong>Thời gian:</strong> <?php the_field('thoi_gian'); ?></p>
              <p><strong>Giá:</strong> <?php the_field('gia_khuyenmai') ? number_format(get_field('gia_khuyenmai'), 0, ',', '.') . ' đ' : 'Liên hệ'; ?></p>
              <a href="<?php the_permalink(); ?>" style="color: #e1703a; font-weight: bold;">Xem chi tiết &raquo;</a>
            </div>
          </div>
        <?php endwhile; ?>
      </div>

      <div style="margin-top: 24px;">
        <?php
        echo paginate_links([
          'total' => $query->max_num_pages
        ]);
        ?>
      </div>

    <?php else: ?>
      <p>Không tìm thấy tour phù hợp.</p>
    <?php endif; ?>
    <?php wp_reset_postdata(); ?>
  </main>
</div>

<?php get_footer(); ?>
