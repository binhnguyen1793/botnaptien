<?php
function hotel_booking_form_shortcode() {
    ob_start();
    $post_id = $_GET['hotel_id'] ?? null;
    $gia_phong = $_GET['price'] ?? 0;

    if (!$post_id || !get_post($post_id) || get_post_type($post_id) !== 'hotel') {
        return '<p style="color:red;">Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch s·∫°n.</p>';
    }

    $tieu_de = get_the_title($post_id);
    $dia_chi = get_field('dia_chi_1', $post_id);

    // L·∫•y th√¥ng tin lo·∫°i ph√≤ng ƒë·∫ßu ti√™n
    $ten_phong = 'Ph√≤ng ti√™u chu·∫©n';
    $dien_tich = '';
    $so_nguoi = '';
    $so_giuong = '';
    $gia_phong = 1000000;

    $room_index = isset($_GET['room_index']) ? intval($_GET['room_index']) : 0;

    if (have_rows('loai_phong', $post_id)) {
        $i = 0;
        while (have_rows('loai_phong', $post_id)) {
            the_row();
            if ($i === $room_index) {
                $ten_phong = get_sub_field('ten_phong') ?: 'Ph√≤ng ti√™u chu·∫©n';
                $dien_tich = get_sub_field('dien_tich_phong');
                $so_nguoi = get_sub_field('so_nguoi');
                $so_giuong = get_sub_field('so_giuong');
                $gia_phong = isset($_GET['price']) ? intval($_GET['price']) : 0;
                break;
            }
            $i++;
        }
    }
    ?>
    <div class="rules-note">
    <strong>Ch√≠nh s√°ch hu·ª∑ ph√≤ng:</strong><br>
    ‚Ä¢ Hu·ª∑ tr∆∞·ªõc ng√†y nh·∫≠n ph√≤ng <strong>t·ªëi thi·ªÉu 7 ng√†y</strong>: Ho√†n 100%.<br>
    ‚Ä¢ Hu·ª∑ sau ƒë√≥: Ho√†n t·ªëi ƒëa 50% ho·∫∑c m·∫•t to√†n b·ªô tu·ª≥ theo ƒëi·ªÅu ki·ªán kh√°ch s·∫°n.<br>
    ‚Ä¢ Ho√†n ti·ªÅn trong <strong>3 ng√†y l√†m vi·ªác</strong> t·ª´ l√∫c ti·∫øp nh·∫≠n.
    </div>
    <div class="hotel-booking-box">
        <h2>Chi ti·∫øt ƒë·∫∑t ph√≤ng</h2>
        <h3><?php echo esc_html($tieu_de); ?></h3>
        <p>üìç <?php echo esc_html($dia_chi); ?></p>

        <div class="checkin-checkout-row">
            <div class="date-group">
                <label>Ng√†y nh·∫≠n ph√≤ng:</label>
                <input type="date" id="checkin" required>
            </div>
            <div class="date-group">
                <label>Ng√†y tr·∫£ ph√≤ng:</label>
                <input type="date" id="checkout" required>
            </div>
        </div>

        <div class="room-quantity">
            <label for="so-phong">S·ªë ph√≤ng:</label>
            <div class="qty-wrapper">
                <button type="button" class="qty-btn" id="minus">‚àí</button>
                <input type="number" id="so-phong" value="1" min="1" step="1">
                <button type="button" class="qty-btn plus" id="plus">+</button>
            </div>
        </div>

        <div class="booking-table">
            <div class="booking-row header">
                <div>S·ªë ƒë√™m ph√≤ng</div>
                <div>Lo·∫°i 1 ph√≤ng</div>
                <div>ƒêi·ªÅu ki·ªán 1 ph√≤ng</div>
                <div>Gi∆∞·ªùng ph·ª•</div>
                <div>Gi√° ph√≤ng/ƒë√™m</div>
            </div>
            <div class="booking-row">
                <div><span id="so-dem">1 ph√≤ng x 1 ƒë√™m</span></div>
                <div>
                    <?php echo esc_html($ten_phong); ?><br>
                    Di·ªán t√≠ch <?php echo esc_html($dien_tich); ?>m¬≤, <?php echo esc_html($so_giuong); ?> gi∆∞·ªùng<br>
                    <a href="#">Xem chi ti·∫øt</a>
                </div>
                <div>
                    Ph√≤ng d√†nh cho <?php echo esc_html($so_nguoi); ?> kh√°ch<br>
                    <b>ƒê√É</b> bao g·ªìm ƒÉn s√°ng<br>
                    <b>ƒê√É</b> bao g·ªìm thu·∫ø VAT v√† ph√≠ d·ªãch v·ª•<br>
                    <span style="color:red">Kh√¥ng ho√†n/h·ªßy ph√≤ng</span>
                </div>
                <div>
                    <select><option>0</option><option>1</option><option>2</option></select>
                </div>
                <div><b><?php echo number_format($gia_phong, 0, ',', '.'); ?>ƒë</b></div>
            </div>
        </div>

        <div class="booking-summary">
            <div class="summary-line">
                <span id="room-summary">1 <?php echo esc_html($ten_phong); ?></span>
                <span id="tien-phong"><?php echo number_format($gia_phong, 0, ',', '.'); ?>ƒë</span>
            </div>
            <div class="summary-line">
                <span>Thu·∫ø & ph√≠</span>
                <span id="thue-phi">463.000ƒë</span>
            </div>
            <div class="discount-box">
                <input type="text" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°">
            </div>
            <div class="summary-line total">
                <span>T·ªïng ti·ªÅn:</span>
                <span style="color: red; font-weight: bold;" id="tong-tien">...</span>
            </div>
            <p><strong>+ <span id="diem-thuong">...</span> ƒëi·ªÉm</strong></p>
        </div>

        <hr style="margin: 30px 0;">
        <div class="contact-info">
            <h3>Th√¥ng tin Li√™n h·ªá</h3>
            <form id="hotel-form" onsubmit="return false;">
                <div class="gender-options">
                    <label class="gender-label">Qu√Ω danh*:</label>
                    <label><input type="radio" name="gender" required> √îng</label>
                    <label><input type="radio" name="gender"> B√†</label>
                    <label><input type="radio" name="gender"> Anh</label>
                    <label><input type="radio" name="gender"> Ch·ªã</label>
                </div>

                <input type="text" id="hotel-name" placeholder="H·ªç v√† t√™n" required style="width: 100%; padding: 8px;"><br><br>
                <input type="text" id="hotel-phone" placeholder="S·ªë ƒëi·ªán tho·∫°i*" required style="width: 48%; padding: 8px; display: inline-block; margin-right: 4%;">
                <input type="email" id="hotel-email" placeholder="Email" style="width: 48%; padding: 8px; display: inline-block;"><br><br>
                <textarea id="hotel-note" placeholder="N·ªôi dung y√™u c·∫ßu" style="width: 100%; height: 80px; padding: 8px;"></textarea><br><br>
                <label><input type="checkbox"> T√¥i mu·ªën xu·∫•t h√≥a ƒë∆°n ƒë·ªè.</label><br><br>

                <div id="qr-popup" style="text-align:center;"></div>
                <button type="button" onclick="submitHotelBooking()" style="background-color: #660000; color: white; padding: 12px 25px; font-size: 16px; border: none; cursor: pointer;">G·ª≠i y√™u c·∫ßu ƒë·∫∑t ph√≤ng</button>
            </form>
        </div>
    </div>

    <script>
    function submitHotelBooking() {
        const name = document.getElementById('hotel-name').value.trim();
        const email = document.getElementById('hotel-email').value.trim();
        const qrPopup = document.getElementById("qr-popup");
        const tongTien = document.getElementById("tong-tien").innerText.replace(/\D/g, "");

        if (!name || !email || !tongTien) {
            alert("Vui l√≤ng nh·∫≠p ƒë·ªß H·ªç t√™n, Email v√† th√¥ng tin thanh to√°n.");
            return;
        }

        qrPopup.innerHTML = `
            <p style="font-weight:bold; color:#cc0000;">ƒêang l·∫•y m√£ QR t·ª± ƒë·ªông... Vui l√≤ng ch·ªù kho·∫£ng 2 ph√∫t</p>
            <div id="countdown" style="font-size:24px; font-weight:bold; margin:10px;">02:00</div>
        `;

        startCountdown(120);

        const formData = new URLSearchParams();
        formData.append('price', tongTien);

        fetch("/wp-json/qrbot/v1/run", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData.toString()
        })
        .then(res => {
            if (!res.ok) throw new Error("QR l·ªói");
            return res.blob();
        })
        .then(blob => {
            const url = URL.createObjectURL(blob);
            showQR(url);
        })
        .catch(() => {
            qrPopup.innerHTML = `<p style='color:red'>L·ªói t·∫°o m√£ QR. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ th·ª≠ l·∫°i.</p>`;
        });
    }

    function startCountdown(duration) {
        let timer = duration;
        const countdown = document.getElementById('countdown');
        const interval = setInterval(() => {
            const minutes = String(Math.floor(timer / 60)).padStart(2, '0');
            const seconds = String(timer % 60).padStart(2, '0');
            countdown.innerText = `${minutes}:${seconds}`;
            if (--timer < 0) clearInterval(interval);
        }, 1000);
    }

    function showQR(qrUrl) {
        const qrPopup = document.getElementById("qr-popup");
        qrPopup.innerHTML = `
            <div style="text-align:center">
                <strong>M√£ QR thanh to√°n:</strong><br>
                <img src="${qrUrl}" style="max-width:300px;"><br><br>
                <label>G·ª≠i ·∫£nh x√°c nh·∫≠n chuy·ªÉn kho·∫£n:
                    <input type="file" id="upload-proof" accept="image/*">
                </label><br><br>
                <button onclick="confirmHotelPayment()">ƒê√£ chuy·ªÉn kho·∫£n</button>
                <p id="confirm-message" style="margin-top:10px; font-weight:bold; color:#cc0000">
                    ‚ö†Ô∏è N·∫øu m√£ QR kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng, vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ t·∫°o m√£ m·ªõi.
                </p>
            </div>
        `;
    }

    function confirmHotelPayment() {
        const fileInput = document.getElementById('upload-proof');
        const msg = document.getElementById('confirm-message');
        if (!fileInput || !fileInput.files.length) {
            msg.innerText = 'Vui l√≤ng g·ª≠i ·∫£nh x√°c nh·∫≠n chuy·ªÉn kho·∫£n tr∆∞·ªõc khi x√°c nh·∫≠n.';
            msg.style.color = 'red';
            return;
        }
        msg.style.color = 'green';
        msg.innerText = 'Qu√Ω kh√°ch vui l√≤ng ki·ªÉm tra email ƒë·ªÉ x√°c nh·∫≠n ƒë·∫∑t th√†nh c√¥ng d·ªãch v·ª•.';
    }
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('hotel_booking_form', 'hotel_booking_form_shortcode');
