from flask import Flask, request, send_file, after_this_request, jsonify
from flask_cors import CORS
import subprocess
import os
import threading

app = Flask(__name__)
CORS(app)

# Táº¡o khÃ³a Ä‘á»ƒ Ä‘áº£m báº£o xá»­ lÃ½ tuáº§n tá»±
bot_lock = threading.Lock()

@app.route("/run-bot", methods=["POST"])
def run_bot():
    price = request.form.get("price", "no-price")
    print(f"ğŸ’° Nháº­n yÃªu cáº§u cháº¡y bot vá»›i giÃ¡: {price}")

    with bot_lock:
        print(f"ğŸ”’ Äang xá»­ lÃ½ bot cho giÃ¡: {price}")
        
        # Gá»i bot xá»­ lÃ½ vá»›i giÃ¡ truyá»n vÃ o
        result = subprocess.run(["python3", "bot.py", price], capture_output=True, text=True)
        print(result.stdout)
        print(result.stderr)

        # ÄÆ°á»ng dáº«n áº£nh
        qr_image_path = os.path.join("static", "qr_code_detected.png")
        full_image_path = os.path.join("static", "full_page.png")

        if os.path.exists(qr_image_path):
            @after_this_request
            def remove_files(response):
                for path in [qr_image_path, full_image_path]:
                    try:
                        if os.path.exists(path):
                            os.remove(path)
                            print(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a áº£nh: {path}")
                    except Exception as e:
                        print(f"âŒ Lá»—i khi xÃ³a áº£nh {path}: {e}")
                return response

            print(f"âœ… HoÃ n táº¥t gá»­i áº£nh QR cho giÃ¡: {price}")
            return send_file(qr_image_path, mimetype="image/png")

        else:
            print("âŒ KhÃ´ng tÃ¬m tháº¥y áº£nh QR!")
            return jsonify({"error": "KhÃ´ng tÃ¬m tháº¥y áº£nh QR Ä‘Ã£ cáº¯t!"}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080)
