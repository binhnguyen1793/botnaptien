from flask import Flask, request, send_file, after_this_request, jsonify
from flask_cors import CORS
import subprocess
import os
import threading

app = Flask(__name__)
CORS(app)

# Tạo khóa để đảm bảo xử lý tuần tự
bot_lock = threading.Lock()

@app.route("/run-bot", methods=["POST"])
def run_bot():
    price = request.form.get("price", "no-price")
    print(f"💰 Nhận yêu cầu chạy bot với giá: {price}")

    with bot_lock:
        print(f"🔒 Đang xử lý bot cho giá: {price}")
        
        # Gọi bot xử lý với giá truyền vào
        result = subprocess.run(["python3", "bot.py", price], capture_output=True, text=True)
        print(result.stdout)
        print(result.stderr)

        # Đường dẫn ảnh
        qr_image_path = os.path.join("static", "qr_code_detected.png")
        full_image_path = os.path.join("static", "full_page.png")

        if os.path.exists(qr_image_path):
            @after_this_request
            def remove_files(response):
                for path in [qr_image_path, full_image_path]:
                    try:
                        if os.path.exists(path):
                            os.remove(path)
                            print(f"🗑️ Đã xóa ảnh: {path}")
                    except Exception as e:
                        print(f"❌ Lỗi khi xóa ảnh {path}: {e}")
                return response

            print(f"✅ Hoàn tất gửi ảnh QR cho giá: {price}")
            return send_file(qr_image_path, mimetype="image/png")

        else:
            print("❌ Không tìm thấy ảnh QR!")
            return jsonify({"error": "Không tìm thấy ảnh QR đã cắt!"}), 500

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080)
